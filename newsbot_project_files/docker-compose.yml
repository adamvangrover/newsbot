version: '3.8'

services:
  backend:
    build:
      context: ./backend # Relative to this docker-compose.yml file
      dockerfile: Dockerfile
    ports:
      - "8000:8000" # Map host port 8000 to container port 8000
    volumes:
      # Mount backend code for development with hot-reloading (if uvicorn --reload is used)
      # For production, you'd typically not mount the code this way.
      - ./backend/app:/app/app
    environment:
      PYTHON_ENV: development
      POSTGRES_USER: newsbot
      POSTGRES_PASSWORD: newsbot
      POSTGRES_DB: newsbot
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
    networks:
      - newsbot_network
    depends_on:
      - db

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:80" # Map host port 3000 to Nginx container port 80
    depends_on:
      - backend
    environment:
      # Vite needs env vars prefixed with VITE_ passed at build time
      # To pass them to Nginx at runtime for dynamic config (e.g. API URL) is more complex
      # Usually, API URL is baked in at build time or fetched from a /config endpoint.
      # For this setup, VITE_API_BASE_URL is used at build time by Vite.
      # If you need to change API URL without rebuilding frontend:
      # 1. Frontend fetches config from backend.
      # 2. Nginx uses  on a template config file.
      # VITE_API_BASE_URL: http://backend:8000/api/v1 # Example for container-to-container communication
      # The above would be used if frontend calls backend via Docker network.
      # If called from browser, it's localhost:8000 or your public host.
      # The current apiClient.ts uses import.meta.env.VITE_API_BASE_URL which is build-time.
      # The .env.example in frontend sets it to localhost:8000.
      # This means frontend built by Docker will try to access localhost:8000 of the *container*,
      # which is not the backend. It should be 'http://backend:8000/api/v1'.
      # This needs to be handled:
      #  a) During  for frontend, pass ARG VITE_API_BASE_URL.
      #  b) Or, frontend fetches this config from a static file served by nginx, which is configured at runtime.
      # For simplicity of MVP, we assume VITE_API_BASE_URL is set correctly during local build or testing.
      # When running , the frontend will use whatever VITE_API_BASE_URL was at its build time.
      # To make this dynamic for docker-compose:
      # You'd modify frontend/Dockerfile to accept an ARG and use it in vite build.
      # And in docker-compose.yml, under frontend build: args: - VITE_API_BASE_URL=http://backend:8000/api/v1
      # This is not implemented yet for simplicity.
      NGINX_PORT: 80
    networks:
      - newsbot_network
    depends_on:
      - db

  db:
    image: postgres:13
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_USER=newsbot
      - POSTGRES_PASSWORD=newsbot
      - POSTGRES_DB=newsbot
    ports:
      - "5432:5432"
    networks:
      - newsbot_network

networks:
  newsbot_network:
    driver: bridge

volumes:
  postgres_data:
